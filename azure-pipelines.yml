# This is a Check Point CloudGuard ShiftLeft Demo pipeline
# In this pipeline we will run through a terraform scan, container image scan
# and a repository scan.

resources:
  repositories:
  - repository: demo-app
    type: github
    endpoint: luykes
    name: luykes/demo-app
  - repository: iac-noncompliant
    type: github
    endpoint: luykes
    name: luykes/cloudguard-iac-noncompliant-terraform

jobs:
- job: SpectralScanning_Secrets
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - checkout: demo-app
  - script: curl -L 'https://get.spectralops.io/latest/x/sh?dsn=$spu-77ab34ae837f4a1dab088c0493d67f67' | sh
    displayName: 'Install Spectral'
  - script: $HOME/.spectral/spectral scan --dsn $spu-77ab34ae837f4a1dab088c0493d67f67 --include-tags base,audit3
    displayName: 'Spectral Scan - Secrets'

- job: SpectralScanning_IaC
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - checkout: demo-app
  - script: curl -L 'https://get.spectralops.io/latest/x/sh?dsn=$spu-77ab34ae837f4a1dab088c0493d67f67' | sh
    displayName: 'Install Spectral'
  - script: $HOME/.spectral/spectral scan --ok --dsn $spu-77ab34ae837f4a1dab088c0493d67f67 --include-tags iac
    displayName: 'Spectral Scan - IaC'

- job: SourceCodeScanning
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - checkout: demo-app
  - task: CmdLine@2
    inputs:
      script: |
        curl -G https://shiftleft-prod.s3.amazonaws.com/blades/shiftleft/bin/linux/amd64/0.0.36/shiftleft -o shiftleft
        chmod +x shiftleft
    displayName: Install ShiftLeft
  - script: ./shiftleft code-scan -t 900 -e $CHKP_CLOUDGUARD_ENV -l ado=shiftleft-binary -r -2003 -s ./
    env:
      #Map secret variables to environment variables
      CHKP_CLOUDGUARD_ID: $181efbbc-0144-4b2d-b615-96257e2e9f7b
      CHKP_CLOUDGUARD_SECRET: $icqxbhz35fthwnxnmj5ku75c
      CHKP_CLOUDGUARD_ENV: $bf860ae2-4784-42d4-90d7-d3c5f21b59e3
    displayName: Running Source Code scan

- job: SourceCodeScanningWithDocker
  pool:
    vmImage: 'ubuntu-latest'
    
  container:
    image: cpemergingtech.azurecr.io/shiftleft-bash:latest
    endpoint: cpemergingtech
  steps:
  - checkout: demo-app
  - script: shiftleft code-scan -t 900 -e $CHKP_CLOUDGUARD_ENV -l ado=shifleft-docker -r -2003 -s ./
    env:
      #Map secret variables to environment variables
      CHKP_CLOUDGUARD_ID: $181efbbc-0144-4b2d-b615-96257e2e9f7b
      CHKP_CLOUDGUARD_SECRET: $icqxbhz35fthwnxnmj5ku75c
      CHKP_CLOUDGUARD_ENV: $bf860ae2-4784-42d4-90d7-d3c5f21b59e3
    displayName: Running Source Code scan using ShiftLeft Docker image

- job:  ContainerImageScan
  pool:
    vmImage: 'ubuntu-latest'

  steps:
  - checkout: demo-app
  - task: DockerInstaller@0
    inputs:
      dockerVersion: '17.09.0-ce'
    displayName: Installing Docker
  - task: CmdLine@2
    inputs:
      script: |
        curl -G https://shiftleft-prod.s3.amazonaws.com/blades/shiftleft/bin/linux/amd64/0.0.36/shiftleft -o shiftleft
        chmod +x shiftleft
    displayName: Install ShiftLeft
  - task: CmdLine@2
    env:
      #Need to map secret variable to environment variables
      CHKP_CLOUDGUARD_ID: $181efbbc-0144-4b2d-b615-96257e2e9f7b
      CHKP_CLOUDGUARD_SECRET: $icqxbhz35fthwnxnmj5ku75c
    inputs:
      script: |
        docker build -t demo-app .
        docker save -o demo-app.tar demo-app
        ./shiftleft image-scan -i demo-app.tar
    displayName: Running Container Image scan

- job: SourceCodeScanningOnWindows
  pool:
    vmImage: 'windows-latest'
  steps:
  - checkout: demo-app
  - task: CmdLine@2
    env:
      #Map secret variables to environment variables
      CHKP_CLOUDGUARD_ID: $181efbbc-0144-4b2d-b615-96257e2e9f7b
      CHKP_CLOUDGUARD_SECRET: $icqxbhz35fthwnxnmj5ku75c
    inputs:
      script: |
        curl -G https://shiftleft-prod.s3.amazonaws.com/blades/shiftleft/bin/windows/amd64/0.0.36/shiftleft.exe -o shiftleft.exe
        shiftleft.exe code-scan -s ./
    displayName: Running Source Code scan on Windows Agent
